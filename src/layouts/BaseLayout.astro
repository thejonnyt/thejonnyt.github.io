---
import { ViewTransitions } from 'astro:transitions';
import InteractiveBackground from '../components/InteractiveBackground.astro';
import TechnicalTermTooltip from '../components/TechnicalTermTooltip.astro';
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
  lang?: string;
}

const {
  title = "Johannes Tauscher - Portfolio & Resume",
  description = "Website and resume of Johannes Tauscher",
  lang = "en"
} = Astro.props;

// Determine if this is German page
const isGerman = Astro.url.pathname.startsWith('/de');
const pageLang = isGerman ? 'de' : lang;
const canonicalUrl = new URL(Astro.url.pathname, Astro.url.origin).toString();
const ogLocale = isGerman ? 'de_DE' : 'en_US';
const ogImagePath = isGerman ? '/og/de.jpg' : '/og/en.jpg';
const ogImageUrl = new URL(ogImagePath, Astro.url).toString();
const ogImageAlt = isGerman ? 'Portrait von Johannes Tauscher' : 'Portrait of Johannes Tauscher';
const englishPath = isGerman ? Astro.url.pathname.replace(/^\/de/, '') || '/' : Astro.url.pathname;
const germanPath = isGerman ? Astro.url.pathname : `/de${Astro.url.pathname === '/' ? '' : Astro.url.pathname}`;
const englishUrl = new URL(englishPath, Astro.url.origin).toString();
const germanUrl = new URL(germanPath, Astro.url.origin).toString();
const personJsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: "Johannes Tauscher",
  url: "https://thejonnyt.github.io/",
  image: ogImageUrl,
  jobTitle: "Technical Generalist",
  sameAs: [
    "https://www.linkedin.com/in/johannes-tauscher/"
  ]
};
---

<!DOCTYPE html>
<html lang={pageLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="Johannes Tauscher" />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:alt" content={ogImageAlt} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={ogImageAlt} />

    <!-- Additional SEO -->
    <meta name="author" content="Johannes Tauscher" />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en" href={englishUrl} />
    <link rel="alternate" hreflang="de" href={germanUrl} />
    <link rel="alternate" hreflang="x-default" href={englishUrl} />

    <title>{title}</title>

    <script type="application/ld+json" set:html={JSON.stringify(personJsonLd)}></script>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- View Transitions for smooth page navigation -->
    <ViewTransitions />

    <!-- Cloudflare Web Analytics (loaded after page load to avoid blocking) -->
  </head>
  <body>
    <InteractiveBackground />
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <slot />
    <TechnicalTermTooltip />

    <script is:inline>
      (function () {
        const loadAnalytics = () => {
          const script = document.createElement('script');
          script.src = 'https://static.cloudflareinsights.com/beacon.min.js';
          script.defer = true;
          script.setAttribute('data-cf-beacon', '{"token": "18c2944ca68243ab9c61ee755d7324fa"}');
          document.head.appendChild(script);
        };

        const scheduleLoad = () => {
          if ('requestIdleCallback' in window) {
            requestIdleCallback(loadAnalytics, { timeout: 2000 });
          } else {
            setTimeout(loadAnalytics, 2000);
          }
        };

        if (document.readyState === 'complete') {
          scheduleLoad();
          return;
        }

        window.addEventListener('load', scheduleLoad, { once: true });
      })();
    </script>
  </body>
</html>
