---
import AudioSummaryPlayer from '../components/AudioSummaryPlayer.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import TermText from '../components/TermText.astro';
import SkillTag from '../components/SkillTag.astro';
import SkillsRadar from '../components/SkillsRadar.astro';
import MagneticContactCarousel from '../components/MagneticContactCarousel.astro';
import PodcastPlayer from '../components/PodcastPlayer.astro';
import LinkedInBadge from '../components/LinkedInBadge.astro';
import Icon from '../components/Icon.astro';
import { Image } from 'astro:assets';
import profileImage from '../assets/profile.jpg';

// Import English content data only
import introData from '../content/intro/data.json';
import educationData from '../content/education/data.json';
import experienceData from '../content/experience/data.json';
import projectsData from '../content/projects/data.json';
import publicationsData from '../content/publications/data.json';
import miscData from '../content/misc/data.json';
import skillsDatabase from '../content/skillsDatabase.json';

// Process skills from database - group featured skills by category
const featuredSkills = Object.entries(skillsDatabase.skills)
  .filter(([_, skill]) => 'featured' in skill && (skill as any).featured)
  .reduce((acc, [name, skill]) => {
    if (!acc[skill.category]) {
      acc[skill.category] = [];
    }
    acc[skill.category].push({ name, ...skill });
    return acc;
  }, {} as Record<string, any[]>);

const skillsCategories = Object.entries(featuredSkills).map(([category, skills]) => ({
  name: category,
  skills: skills.sort((a, b) => b.yearsOfExperience - a.yearsOfExperience)
}));

const cvSource = {
  profile: introData,
  experience: experienceData,
  education: educationData,
  skillsDatabase,
  projects: projectsData,
  publications: publicationsData,
  awards: miscData.awards,
  language: 'en'
};

// Helper function to format dates
function formatDate(dateStr: string): string {
  if (dateStr === 'present') return 'Present';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
}
---

<BaseLayout title={`${introData.name} - Portfolio & Resume`} description={introData.tagline}>
  <Header cvSource={cvSource} />

  <main id="main-content" class="container" role="main">
    <!-- Hero / Introduction Section -->
    <section class="hero section" aria-label="Introduction">
      <div class="hero-content">
        <div class="profile-image-wrapper">
          <a href="/images/profile.jpg" target="_blank" rel="noopener noreferrer" aria-label={`Open high-resolution profile photo of ${introData.name}`}>
            <Image
              src={profileImage}
              alt={`Profile photo of ${introData.name}`}
              width={234}
              height={234}
              class="profile-image"
              loading="eager"
              fetchpriority="high"
              format="webp"
              widths={[234, 468]}
              sizes="(max-width: 640px) 195px, 234px"
            />
          </a>
        </div>
        <div class="hero-text">
          <h1>{introData.name}<span class="degree">, M.Sc.</span></h1>
          <p class="tagline">{introData.title}</p>
          <p class="text-muted hero-tagline">{introData.tagline}</p>

          <div class="contact-links">
            {introData.email && (
              <a href={`mailto:${introData.email}`} class="contact-link" aria-label="Send email">
                <Icon name="mail" class="icon" ariaHidden="true" />
                <span>Email</span>
              </a>
            )}
            {introData.github && (
              <a href={introData.github} target="_blank" rel="noopener noreferrer" class="contact-link" aria-label="GitHub profile (opens in new tab)">
                <Icon name="github" class="icon" ariaHidden="true" />
                <span>GitHub</span>
              </a>
            )}
            {introData.linkedin && (
              <a href={introData.linkedin} target="_blank" rel="noopener noreferrer" class="contact-link" aria-label="LinkedIn profile (opens in new tab)">
                <Icon name="linkedin" class="icon" ariaHidden="true" />
                <span>LinkedIn</span>
              </a>
            )}
          </div>
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section id="about" class="section" aria-labelledby="about-heading">
      <h2 id="about-heading">About</h2>
      <div class="bio-expandable">
        <div class="bio-preview">
          <TermText text={introData.bio[0]} as="p" />
        </div>
        {introData.bio.length > 1 && (
          <div class="bio-full" id="bio-full-content" style="display: none;">
            {introData.bio.slice(1).map((paragraph: string) => (
              <TermText text={paragraph} as="p" />
            ))}
          </div>
        )}
        {introData.bio.length > 1 && (
          <button class="bio-toggle" aria-expanded="false" aria-controls="bio-full-content">
            <span class="toggle-text">Read more</span>
            <svg class="chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        )}
      </div>
    </section>

    <!-- Audio Summary Section -->
    <section id="audio-summary" class="section" aria-labelledby="audio-summary-heading">
      <div class="audio-summary-header">
        <button class="audio-summary-trigger play-pause-btn" type="button" aria-expanded="false" aria-controls="audio-summary-player" aria-label="Play audio summary">
          <Icon name="play" class="icon play-icon" ariaHidden="true" />
          <Icon name="pause" class="icon pause-icon" ariaHidden="true" style="display: none;" />
        </button>
        <h3 id="audio-summary-heading">Audio Summary</h3>
      </div>
      <p>Listen to the Summary of Johannes Profile by Google's NotebookLM.</p>
      <div id="audio-summary-player" class="audio-summary-player" hidden>
        <AudioSummaryPlayer />
      </div>
    </section>

    <!-- Experience Section -->
    <section id="experience" class="section" aria-labelledby="experience-heading">
      <h2 id="experience-heading">Experience</h2>
      {experienceData.map((exp: any, index: number) => (
        <div class="timeline-item" data-experience-index={index} data-hidden={index >= 5 ? 'true' : 'false'}>
          <div class="timeline-header">
            <div>
              <h3>{exp.position}</h3>
              <p class="text-muted">{exp.company} • {exp.location}</p>
            </div>
            <p class="text-muted date">
              {formatDate(exp.startDate)} - {exp.current ? 'Present' : formatDate(exp.endDate)}
            </p>
          </div>
          <TermText text={exp.description} as="p" />
          <ul>
            {exp.achievements.map((achievement: string) => (
              <TermText text={achievement} as="li" />
            ))}
          </ul>
          {exp.technologies && exp.technologies.length > 0 && (
            <div class="tags">
              {exp.technologies.map((tech: string) => (
                <SkillTag skillName={tech} />
              ))}
            </div>
          )}
        </div>
      ))}
      <button class="experience-toggle" aria-expanded="false" id="experience-toggle">
        <span class="toggle-text">Show more experience</span>
        <svg class="chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </section>

    <!-- Projects Section -->
    <section id="projects" class="section" aria-labelledby="projects-heading">
      <h2 id="projects-heading">Projects</h2>
      {projectsData.filter((p: any) => p.featured).map((project: any, index: number) => (
        <div class="project-card">
          <div class="project-header">
            <div class="project-title-area">
              <h3>{project.name}</h3>
              <p class="text-muted">{project.tagline}</p>
            </div>
            {project.links?.Video && (
              <button
                class="video-thumbnail"
                data-project-index={index}
                aria-label={`Play ${project.name} video`}
                aria-expanded="false"
                aria-controls={`video-container-${index}`}
              >
                <img
                  class="video-thumbnail-image"
                  src={`https://vumbnail.com/${project.links.Video.split('/').pop()}.jpg`}
                  alt=""
                  loading="lazy"
                  decoding="async"
                />
                <div class="play-icon" aria-hidden="true">▶</div>
              </button>
            )}
          </div>
          {project.links?.Video && (
            <div
              class="video-container"
              id={`video-container-${index}`}
              data-project-index={index}
              data-video-src={`https://player.vimeo.com/video/${project.links.Video.split('/').pop()}?h=15018e51f5`}
              data-video-title={`${project.name} video`}
              style="display: none;"
              role="region"
              aria-label={`${project.name} video player`}
            />
          )}
          <p>{project.description}</p>
          {project.highlights && (
            <ul>
              {project.highlights.map((highlight: string) => (
                <li>{highlight}</li>
              ))}
            </ul>
          )}
          <div class="tags">
            {project.technologies.map((tech: string) => (
              <SkillTag skillName={tech} />
            ))}
          </div>
          {project.links?.Podcast && (
            <PodcastPlayer src={project.links.Podcast} title="Listen to thesis podcast" />
          )}
          {project.links && Object.keys(project.links).length > 0 && (
            <div class="project-links">
              {Object.entries(project.links).map(([label, url]: [string, any]) => {
                // Skip Video and Podcast links as they're handled separately
                if (label === 'Video' || label === 'Podcast') return null;

                // If the value is an object with url and text, use that
                if (typeof url === 'object' && url.url) {
                  return (
                    <a href={url.url} target="_blank" rel="noopener noreferrer" aria-label={`${url.text} (opens in new tab)`}>{url.text} →</a>
                  );
                }

                // Otherwise use the label as text
                return (
                  <a href={url} target="_blank" rel="noopener noreferrer" aria-label={`${label} (opens in new tab)`}>{label} →</a>
                );
              })}
            </div>
          )}
        </div>
      ))}
    </section>

    <!-- Publications Section -->
    {publicationsData.length > 0 && (
      <section id="publications" class="section" aria-labelledby="publications-heading">
        <h2 id="publications-heading">Publications</h2>
        {publicationsData.map((pub: any) => (
          <div class="publication-item">
            <TermText text={pub.title} as="h3" />
            <p class="text-muted">
              {pub.authors.join(', ')} • {pub.venue}, {pub.year}
              {pub.citations && <span> • {pub.citations} citations</span>}
            </p>
            {pub.abstract && (
              <details class="abstract-toggle">
                <summary>
                  <span class="abstract-label">Abstract</span>
                  <svg class="chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <TermText text={pub.abstract} as="p" class="abstract-content" />
              </details>
            )}
            <div class="publication-links">
              {pub.links.doi && (
                <a href={pub.links.doi} target="_blank" rel="noopener noreferrer" aria-label="View DOI (opens in new tab)">DOI →</a>
              )}
              {pub.links.paper && (
                <a href={pub.links.paper} target="_blank" rel="noopener noreferrer" aria-label="View paper (opens in new tab)">Paper →</a>
              )}
              {pub.links.code && (
                <a href={pub.links.code} target="_blank" rel="noopener noreferrer" aria-label="View code (opens in new tab)">Code →</a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    <!-- Education Section -->
    <section id="education" class="section" aria-labelledby="education-heading">
      <h2 id="education-heading">Education</h2>
      {educationData.map((edu: any) => (
        <div class="timeline-item">
          <div class="timeline-header">
            <div>
              <h3>{edu.degree} in {edu.field}</h3>
              <p class="text-muted">{edu.institution} • {edu.location}</p>
            </div>
            <p class="text-muted date">
              {formatDate(edu.startDate)} - {formatDate(edu.endDate)}
            </p>
          </div>
          {edu.description && <TermText text={edu.description} as="p" />}
          {edu.highlights && (
            <ul>
              {edu.highlights.map((highlight: string) => (
                <TermText text={highlight} as="li" />
              ))}
            </ul>
          )}
        </div>
      ))}
    </section>

    <!-- Skills Section -->
    <section id="skills" class="section" aria-labelledby="skills-heading">
      <h2 id="skills-heading">Skills</h2>
      <div class="skills-grid">
        {skillsCategories.flatMap((category: any) =>
          category.skills.map((skill: any) => (
            <SkillTag skillName={skill.name} showStars={true} />
          ))
        )}
      </div>

      <div class="skills-radar-wrapper">
        <SkillsRadar size={750} />
      </div>
    </section>

    <!-- Programs & Awards Section -->
    {(miscData.programs?.length > 0 || miscData.awards?.length > 0) && (
      <section id="awards" class="section" aria-labelledby="awards-heading">
        <h2 id="awards-heading">Programs & Awards</h2>
        {miscData.programs?.length > 0 && (
          <div class="award-group">
            <h3 class="award-group-title">Programs</h3>
            {miscData.programs.map((program: any) => (
              <div class="award-item">
                <div class="award-header">
                  <h4>{program.title}</h4>
                  {program.year && <p class="text-muted award-year">{program.year}</p>}
                </div>
                <p class="text-muted award-meta">
                  {program.organization}
                  {program.location && <span> · {program.location}</span>}
                </p>
                {program.description && <TermText text={program.description} as="p" />}
                {program.achievements?.length > 0 && (
                  <ul>
                    {program.achievements.map((achievement: string) => (
                      <TermText text={achievement} as="li" />
                    ))}
                  </ul>
                )}
              </div>
            ))}
          </div>
        )}
        {miscData.awards?.length > 0 && (
          <div class="award-group">
            <h3 class="award-group-title">Awards</h3>
            {miscData.awards.map((award: any) => (
              <div class="award-item">
                <div class="award-header">
                  <h4>{award.title}</h4>
                  {award.year && <p class="text-muted award-year">{award.year}</p>}
                </div>
                <p class="text-muted award-meta">
                  {award.organization}
                  {award.location && <span> · {award.location}</span>}
                </p>
                {award.description && <TermText text={award.description} as="p" />}
                {award.achievements?.length > 0 && (
                  <ul>
                    {award.achievements.map((achievement: string) => (
                      <TermText text={achievement} as="li" />
                    ))}
                  </ul>
                )}
              </div>
            ))}
          </div>
        )}
      </section>
    )}

    <!-- Contact Section -->
    <section id="contact" class="section contact-section" aria-labelledby="contact-heading">
      <h2 id="contact-heading">Get in Touch</h2>
      <p>I'm currently looking for new opportunities. Feel free to reach out!</p>

      <div class="linkedin-badge-wrapper">
        <LinkedInBadge
          name={introData.name}
          title={introData.title}
          location={introData.location}
          profileUrl={introData.linkedin}
          imageSrc={profileImage}
          ctaLabel="View LinkedIn Profile"
          ariaLabel={`View ${introData.name}'s LinkedIn profile (opens in new tab)`}
        />
      </div>

      <MagneticContactCarousel email={introData.email} language="en" cvSource={cvSource} />
    </section>
  </main>

  <Footer cvSource={cvSource} />
</BaseLayout>

<style>
  .hero {
    padding: var(--space-lg) 0;
  }

  .hero-content {
    display: flex;
    align-items: center;
    gap: var(--space-xl);
  }

  .profile-image-wrapper {
    flex-shrink: 0;
  }

  .profile-image {
    width: 234px;
    height: 234px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--color-border);
    transition: border-color var(--transition-normal), transform var(--transition-normal);
  }

  .profile-image:hover {
    border-color: var(--color-accent);
    transform: scale(1.05);
  }

  .hero-text {
    flex: 1;
  }

  .hero h1 {
    font-size: 3rem;
    margin-bottom: var(--space-sm);
  }

  .hero h1 .degree {
    font-weight: 400;
    opacity: 0.8;
  }

  .tagline {
    font-size: 1.5rem;
    margin-bottom: var(--space-sm);
    color: var(--color-muted);
  }

  .hero-tagline {
    font-size: 1rem;
    line-height: 1.5;
  }

  .contact-links {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-lg);
    flex-wrap: wrap;
  }

  .contact-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    transition: all var(--transition-fast);
    font-size: 0.9rem;
  }

  .contact-link:hover {
    background-color: var(--color-bg-secondary);
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  .contact-link .icon {
    width: 18px;
    height: 18px;
  }

  /* Bio expandable section */
  .bio-expandable {
    position: relative;
  }

  .bio-preview {
    margin-bottom: var(--space-md);
  }

  .bio-full {
    animation: slideDown 0.3s ease-out;
  }

  .bio-toggle {
    background: transparent;
    border: none;
    color: var(--color-accent);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
    font-weight: 500;
    font-size: 0.95rem;
    transition: color var(--transition-fast);
    margin-top: var(--space-sm);
    font-family: inherit;
  }

  .bio-toggle:hover {
    color: var(--color-accent-hover);
  }

  .bio-toggle .chevron {
    transition: transform var(--transition-normal);
    flex-shrink: 0;
  }

  /* Timeline items (for experience & education) */
  .timeline-item {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .timeline-item:last-child {
    border-bottom: none;
  }

  .timeline-item[data-hidden="true"] {
    display: none;
  }

  .experience-toggle {
    background: transparent;
    border: none;
    color: var(--color-accent);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) 0;
    font-weight: 500;
    font-size: 0.95rem;
    transition: color var(--transition-fast);
    margin-top: var(--space-md);
    font-family: inherit;
  }

  .experience-toggle:hover {
    color: var(--color-accent-hover);
  }

  .experience-toggle .chevron {
    transition: transform var(--transition-normal);
    flex-shrink: 0;
  }

  .timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-md);
    gap: var(--space-lg);
  }

  .timeline-header h3 {
    margin-bottom: var(--space-xs);
  }

  .date {
    white-space: nowrap;
    font-size: 0.9rem;
  }

  /* Project cards */
  .project-card {
    margin-bottom: var(--space-xl);
    padding: var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    transition: border-color var(--transition-normal);
  }

  .project-card:hover {
    border-color: var(--color-accent);
  }

  .project-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-lg);
    margin-bottom: var(--space-md);
  }

  .project-title-area {
    flex: 1;
  }

  .project-card h3 {
    margin-bottom: var(--space-xs);
  }

  .video-thumbnail {
    width: 120px;
    height: 68px;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    border: none;
    padding: 0;
    font-family: inherit;
  }

  .video-thumbnail-image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
  }

  .video-thumbnail::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity var(--transition-fast);
    z-index: 1;
  }

  .video-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
  }

  .video-thumbnail:hover::before {
    opacity: 1;
  }

  .play-icon {
    color: white;
    font-size: 2rem;
    position: relative;
    z-index: 2;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .video-container {
    margin-bottom: var(--space-lg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .video-container iframe {
    display: block;
    width: 100%;
  }

  .project-links {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-md);
  }


  /* Publication items */
  .publication-item {
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--color-border);
  }

  .publication-item:last-child {
    border-bottom: none;
  }

  .publication-item h3 {
    margin-bottom: var(--space-xs);
  }

  .publication-links {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-md);
  }

  /* Skills */
  .skills-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
  }

  .skills-radar-wrapper {
    margin-top: var(--space-2xl);
    display: flex;
    justify-content: center;
  }

  /* Awards */
  .award-item {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .award-item:last-child {
    border-bottom: none;
  }

  .award-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-lg);
    margin-bottom: var(--space-xs);
  }

  .award-header h3 {
    margin-bottom: 0;
  }

  .award-header h4 {
    margin-bottom: 0;
  }

  .award-year {
    white-space: nowrap;
    font-size: 0.9rem;
  }

  .award-meta {
    margin-bottom: var(--space-sm);
  }

  .award-group-title {
    margin-bottom: var(--space-md);
    font-size: 1.1rem;
  }

  .award-group + .award-group {
    margin-top: var(--space-xl);
  }

  /* Tags */
  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-md);
  }

  .tag {
    display: inline-block;
    padding: var(--space-xs) var(--space-md);
    background-color: var(--color-bg-secondary);
    border-radius: 4px;
    font-size: 0.85rem;
    color: var(--color-foreground);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
    cursor: help;
  }

  .tag:hover {
    background-color: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  /* Contact Section */
  .contact-section {
    text-align: center;
  }

  .contact-section .contact-links {
    justify-content: center;
  }

  /* LinkedIn Badge */
  .linkedin-badge-wrapper {
    margin: var(--space-xl) auto;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Button */
  .button {
    display: inline-block;
    padding: var(--space-md) var(--space-lg);
    background-color: var(--color-accent);
    color: white;
    border-radius: 6px;
    font-weight: 500;
    transition: background-color var(--transition-fast);
  }

  .button:hover {
    background-color: var(--color-accent-hover);
    color: white;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .hero-content {
      flex-direction: column;
      text-align: center;
      gap: var(--space-lg);
    }

    .profile-image {
      width: 195px;
      height: 195px;
    }

    .contact-links {
      justify-content: center;
    }

    .hero h1 {
      font-size: 2rem;
    }

    .tagline {
      font-size: 1.25rem;
    }

    .timeline-header {
      flex-direction: column;
      gap: var(--space-sm);
    }

    .date {
      white-space: normal;
    }

    .award-header {
      flex-direction: column;
      gap: var(--space-xs);
    }

    .award-year {
      white-space: normal;
    }

    .project-header {
      flex-direction: column;
      gap: var(--space-md);
    }

    .video-thumbnail {
      width: 100%;
      height: 180px;
    }

    .video-container iframe {
      height: 250px;
    }
  }
</style>

<script define:vars={{ experienceData }}>
  // Make experience data available to client-side JavaScript
  window.__experienceData = experienceData;
</script>

<script>
  // Initialize Lucide icons

  // Handle experience section toggle
  document.addEventListener('DOMContentLoaded', () => {
    // Calculate years of hidden experience
    const hiddenExperiences = document.querySelectorAll('.timeline-item[data-hidden="true"]');
    let totalYears = 0;

    hiddenExperiences.forEach(exp => {
      const index = parseInt(exp.getAttribute('data-experience-index') || '0');
      const expData = (window as any).__experienceData[index];
      if (expData) {
        const startDate = new Date(expData.startDate);
        const endDate = expData.current || expData.endDate === 'present'
          ? new Date()
          : new Date(expData.endDate);
        const years = (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 365.25);
        totalYears += years;
      }
    });

    const roundedYears = Math.round(totalYears);
    const toggleButton = document.getElementById('experience-toggle');
    const toggleText = toggleButton?.querySelector('.toggle-text');

    if (toggleText && roundedYears > 0) {
      toggleText.textContent = `Show ${roundedYears} more year${roundedYears !== 1 ? 's' : ''} of experience`;
    }

    // Handle toggle click
    if (toggleButton) {
      toggleButton.addEventListener('click', () => {
        const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
        const chevron = toggleButton.querySelector('.chevron') as HTMLElement;

        hiddenExperiences.forEach(exp => {
          const expEl = exp as HTMLElement;
          if (!isExpanded) {
            expEl.style.display = 'block';
            expEl.setAttribute('data-hidden', 'false');
          } else {
            expEl.style.display = 'none';
            expEl.setAttribute('data-hidden', 'true');
          }
        });

        if (!isExpanded) {
          toggleButton.setAttribute('aria-expanded', 'true');
          if (toggleText) toggleText.textContent = 'Show less experience';
          if (chevron) chevron.style.transform = 'rotate(180deg)';
        } else {
          toggleButton.setAttribute('aria-expanded', 'false');
          if (toggleText) toggleText.textContent = `Show ${roundedYears} more year${roundedYears !== 1 ? 's' : ''} of experience`;
          if (chevron) chevron.style.transform = 'rotate(0deg)';
        }
      });
    }

    // Handle video thumbnail clicks
    const thumbnails = document.querySelectorAll('.video-thumbnail');

    thumbnails.forEach(thumbnailEl => {
      const thumbnail = thumbnailEl as HTMLElement;

      // Make it keyboard accessible
      thumbnail.addEventListener('click', () => {
        toggleVideo(thumbnail);
      });

      thumbnail.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleVideo(thumbnail);
        }
      });
    });

    function toggleVideo(thumbnail: HTMLElement) {
      const projectIndex = thumbnail.getAttribute('data-project-index');
      const videoContainer = document.querySelector(`.video-container[data-project-index="${projectIndex}"]`) as HTMLElement | null;

      if (videoContainer) {
        const isExpanded = thumbnail.getAttribute('aria-expanded') === 'true';

        if (!isExpanded) {
          if (!videoContainer.querySelector('iframe')) {
            const videoSrc = videoContainer.getAttribute('data-video-src');
            const videoTitle = videoContainer.getAttribute('data-video-title') || 'Project video';

            if (videoSrc) {
              const iframe = document.createElement('iframe');
              iframe.title = videoTitle;
              iframe.src = videoSrc;
              iframe.width = '100%';
              iframe.height = '400';
              iframe.referrerPolicy = 'strict-origin-when-cross-origin';
              iframe.allow = 'autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share';
              iframe.setAttribute('allowfullscreen', '');
              videoContainer.appendChild(iframe);
            }
          }

          videoContainer.style.display = 'block';
          thumbnail.style.opacity = '0.5';
          thumbnail.setAttribute('aria-expanded', 'true');
        } else {
          videoContainer.style.display = 'none';
          thumbnail.style.opacity = '1';
          thumbnail.setAttribute('aria-expanded', 'false');
        }
      }
    }

    // Handle audio summary play trigger
    const audioSummarySection = document.getElementById('audio-summary');
    const audioSummaryTrigger = audioSummarySection?.querySelector('.audio-summary-trigger') as HTMLButtonElement | null;
    const audioSummaryPlayer = audioSummarySection?.querySelector('.audio-summary-player') as HTMLElement | null;

    if (audioSummaryTrigger && audioSummaryPlayer) {
      audioSummaryTrigger.addEventListener('click', () => {
        const isHidden = audioSummaryPlayer.hasAttribute('hidden');
        if (isHidden) {
          audioSummaryPlayer.removeAttribute('hidden');
          audioSummaryTrigger.setAttribute('aria-expanded', 'true');
        }

        let attempts = 0;
        const maxAttempts = 20;
        const interval = window.setInterval(() => {
          attempts += 1;
          const playButton = audioSummaryPlayer.querySelector('.play-pause-btn') as HTMLButtonElement | null;
          if (playButton && audioSummaryPlayer.querySelector('.audio-summary-player-wrapper')?.getAttribute('data-initialized') === 'true') {
            playButton.click();
            window.clearInterval(interval);
          } else if (attempts >= maxAttempts) {
            window.clearInterval(interval);
          }
        }, 100);
      });
    }

    // Handle bio expand/collapse
    const bioToggles = document.querySelectorAll('.bio-toggle');

    bioToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const expandable = button.closest('.bio-expandable');
        if (!expandable) return;

        const bioFull = expandable.querySelector('.bio-full') as HTMLElement;
        const toggleText = button.querySelector('.toggle-text');
        const chevron = button.querySelector('.chevron') as HTMLElement;
        const isExpanded = button.getAttribute('aria-expanded') === 'true';

        if (!isExpanded) {
          // Expand
          bioFull.style.display = 'block';
          if (toggleText) toggleText.textContent = 'Read less';
          if (chevron) chevron.style.transform = 'rotate(180deg)';
          button.setAttribute('aria-expanded', 'true');
        } else {
          // Collapse
          bioFull.style.display = 'none';
          if (toggleText) toggleText.textContent = 'Read more';
          if (chevron) chevron.style.transform = 'rotate(0deg)';
          button.setAttribute('aria-expanded', 'false');
        }
      });
    });
  });
</script>
