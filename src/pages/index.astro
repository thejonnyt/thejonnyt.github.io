---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import TermText from '../components/TermText.astro';
import SkillTag from '../components/SkillTag.astro';
import { Image } from 'astro:assets';

// Import English content data
import introData from '../content/intro/data.json';
import educationData from '../content/education/data.json';
import experienceData from '../content/experience/data.json';
import projectsData from '../content/projects/data.json';
import publicationsData from '../content/publications/data.json';
import miscData from '../content/misc/data.json';
import skillsDatabase from '../content/skillsDatabase.json';

// Import German content data
import introDataDe from '../content/intro/data.de.json';
import educationDataDe from '../content/education/data.de.json';
import experienceDataDe from '../content/experience/data.de.json';
import projectsDataDe from '../content/projects/data.de.json';
import publicationsDataDe from '../content/publications/data.de.json';
import miscDataDe from '../content/misc/data.de.json';

// Process skills from database - group featured skills by category
const featuredSkills = Object.entries(skillsDatabase.skills)
  .filter(([_, skill]) => skill.featured)
  .reduce((acc, [name, skill]) => {
    if (!acc[skill.category]) {
      acc[skill.category] = [];
    }
    acc[skill.category].push({ name, ...skill });
    return acc;
  }, {} as Record<string, any[]>);

const skillsCategories = Object.entries(featuredSkills).map(([category, skills]) => ({
  name: category,
  skills: skills.sort((a, b) => b.yearsOfExperience - a.yearsOfExperience)
}));

// Create content map for easy access
const content = {
  en: { intro: introData, education: educationData, experience: experienceData, projects: projectsData, publications: publicationsData, skills: { categories: skillsCategories }, misc: miscData },
  de: { intro: introDataDe, education: educationDataDe, experience: experienceDataDe, projects: projectsDataDe, publications: publicationsDataDe, skills: { categories: skillsCategories }, misc: miscDataDe }
};

// Helper function to format dates
function formatDate(dateStr: string, lang: string = 'en'): string {
  if (dateStr === 'present') return lang === 'en' ? 'Present' : 'Aktuell';
  const date = new Date(dateStr);
  const locale = lang === 'en' ? 'en-US' : 'de-DE';
  return date.toLocaleDateString(locale, { year: 'numeric', month: 'short' });
}

// Section labels for both languages
const labels = {
  en: {
    about: 'About',
    experience: 'Experience',
    projects: 'Projects',
    publications: 'Publications',
    education: 'Education',
    skills: 'Skills',
    awards: 'Awards & Recognition',
    contact: 'Get in Touch',
    contactText: "I'm currently looking for new opportunities. Feel free to reach out!",
    sendEmail: 'Send me an email',
    abstract: 'Abstract',
    citations: 'citations'
  },
  de: {
    about: 'Über mich',
    experience: 'Erfahrung',
    projects: 'Projekte',
    publications: 'Publikationen',
    education: 'Ausbildung',
    skills: 'Fähigkeiten',
    awards: 'Auszeichnungen & Anerkennungen',
    contact: 'Kontakt',
    contactText: 'Ich bin derzeit auf der Suche nach neuen Möglichkeiten.',
    sendEmail: 'Kontaktieren Sie mich gerne!',
    abstract: 'Zusammenfassung',
    citations: 'Zitierungen'
  }
};
---

<BaseLayout title={`${introData.name} - Portfolio & Resume`} description={introData.tagline}>
  <Header />

  {(['en', 'de'] as const).map(lang => {
    const intro = content[lang].intro;
    const education = content[lang].education;
    const experience = content[lang].experience;
    const projects = content[lang].projects;
    const publications = content[lang].publications;
    const skills = content[lang].skills;
    const misc = content[lang].misc;
    const l = labels[lang];

    return (
  <main class="container" data-lang={lang}>
    <!-- Hero / Introduction Section -->
    <section class="hero section">
      <div class="hero-content">
        <div class="profile-image-wrapper">
          <Image
            src="/images/profile.jpg"
            alt={intro.name}
            width={180}
            height={180}
            class="profile-image"
            loading="eager"
            format="webp"
          />
        </div>
        <div class="hero-text">
          <h1>{intro.name}<span class="degree">, M.Sc.</span></h1>
          <p class="tagline">{intro.title}</p>
          <p class="text-muted hero-tagline">{intro.tagline}</p>

          <div class="contact-links">
            {intro.email && (
              <a href={`mailto:${intro.email}`} class="contact-link">
                <i data-lucide="mail" class="icon"></i>
                <span>Email</span>
              </a>
            )}
            {intro.github && (
              <a href={intro.github} target="_blank" rel="noopener" class="contact-link">
                <i data-lucide="github" class="icon"></i>
                <span>GitHub</span>
              </a>
            )}
            {intro.linkedin && (
              <a href={intro.linkedin} target="_blank" rel="noopener" class="contact-link">
                <i data-lucide="linkedin" class="icon"></i>
                <span>LinkedIn</span>
              </a>
            )}
          </div>
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section id={`about-${lang}`} class="section" data-section="about">
      <h2>{l.about}</h2>
      <div class="bio-expandable">
        <div class="bio-preview">
          <TermText text={intro.bio[0]} as="p" />
        </div>
        {intro.bio.length > 1 && (
          <div class="bio-full" style="display: none;">
            {intro.bio.slice(1).map((paragraph: string) => (
              <TermText text={paragraph} as="p" />
            ))}
          </div>
        )}
        {intro.bio.length > 1 && (
          <button class="bio-toggle" data-lang-scope={lang}>
            <span class="toggle-text">{lang === 'en' ? 'Read more' : 'Mehr lesen'}</span>
            <svg class="chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        )}
      </div>
    </section>

    <!-- Experience Section -->
    <section id={`experience-${lang}`} class="section" data-section="experience">
      <h2>{l.experience}</h2>
      {experience.map((exp: any) => (
        <div class="timeline-item">
          <div class="timeline-header">
            <div>
              <h3>{exp.position}</h3>
              <p class="text-muted">{exp.company} • {exp.location}</p>
            </div>
            <p class="text-muted date">
              {formatDate(exp.startDate, lang)} - {exp.current ? (lang === 'en' ? 'Present' : 'Aktuell') : formatDate(exp.endDate, lang)}
            </p>
          </div>
          <TermText text={exp.description} as="p" />
          <ul>
            {exp.achievements.map((achievement: string) => (
              <TermText text={achievement} as="li" />
            ))}
          </ul>
          {exp.technologies && exp.technologies.length > 0 && (
            <div class="tags">
              {exp.technologies.map((tech: string) => (
                <SkillTag skillName={tech} />
              ))}
            </div>
          )}
        </div>
      ))}
    </section>

    <!-- Projects Section -->
    <section id={`projects-${lang}`} class="section" data-section="projects">
      <h2>{l.projects}</h2>
      {projects.filter((p: any) => p.featured).map((project: any, index: number) => (
        <div class="project-card">
          <div class="project-header">
            <div class="project-title-area">
              <h3>{project.name}</h3>
              <p class="text-muted">{project.tagline}</p>
            </div>
            {project.links?.Video && (
              <div class="video-thumbnail" data-project-index={index}>
                <div class="play-icon">▶</div>
              </div>
            )}
          </div>
          <div class="video-container" data-project-index={index} style="display: none;">
            {project.links?.Video && (
              <iframe
                title={`${project.name} video`}
                src={`https://player.vimeo.com/video/${project.links.Video.split('/').pop()}?h=15018e51f5`}
                width="100%"
                height="400"
                frameborder="0"
                referrerpolicy="strict-origin-when-cross-origin"
                allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share"
                allowfullscreen
              />
            )}
          </div>
          <p>{project.description}</p>
          {project.highlights && (
            <ul>
              {project.highlights.map((highlight: string) => (
                <li>{highlight}</li>
              ))}
            </ul>
          )}
          <div class="tags">
            {project.technologies.map((tech: string) => (
              <SkillTag skillName={tech} />
            ))}
          </div>
          {project.links && Object.keys(project.links).length > 0 && (
            <div class="project-links">
              {Object.entries(project.links).map(([label, url]: [string, any]) => {
                // Skip Video link as it's handled separately
                if (label === 'Video') return null;

                // If the value is an object with url and text, use that
                if (typeof url === 'object' && url.url) {
                  return (
                    <a href={url.url} target="_blank" rel="noopener">{url.text} →</a>
                  );
                }

                // Otherwise use the label as text
                return (
                  <a href={url} target="_blank" rel="noopener">{label} →</a>
                );
              })}
            </div>
          )}
        </div>
      ))}
    </section>

    <!-- Publications Section -->
    {publications.length > 0 && (
      <section id={`publications-${lang}`} class="section" data-section="publications">
        <h2>{l.publications}</h2>
        {publications.map((pub: any, index: number) => (
          <div class="publication-item">
            <TermText text={pub.title} as="h3" />
            <p class="text-muted">
              {pub.authors.join(', ')} • {pub.venue}, {pub.year}
              {pub.citations && <span> • {pub.citations} {l.citations}</span>}
            </p>
            {pub.abstract && (
              <details class="abstract-toggle">
                <summary>
                  <span class="abstract-label">{l.abstract}</span>
                  <svg class="chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <TermText text={pub.abstract} as="p" class="abstract-content" />
              </details>
            )}
            <div class="publication-links">
              {pub.links.doi && (
                <a href={pub.links.doi} target="_blank" rel="noopener">DOI →</a>
              )}
              {pub.links.paper && (
                <a href={pub.links.paper} target="_blank" rel="noopener">Paper →</a>
              )}
              {pub.links.code && (
                <a href={pub.links.code} target="_blank" rel="noopener">Code →</a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    <!-- Education Section -->
    <section id={`education-${lang}`} class="section" data-section="education">
      <h2>{l.education}</h2>
      {education.map((edu: any) => (
        <div class="timeline-item">
          <div class="timeline-header">
            <div>
              <h3>{edu.degree} in {edu.field}</h3>
              <p class="text-muted">{edu.institution} • {edu.location}</p>
            </div>
            <p class="text-muted date">
              {formatDate(edu.startDate, lang)} - {formatDate(edu.endDate, lang)}
            </p>
          </div>
          {edu.description && <TermText text={edu.description} as="p" />}
          {edu.highlights && (
            <ul>
              {edu.highlights.map((highlight: string) => (
                <TermText text={highlight} as="li" />
              ))}
            </ul>
          )}
        </div>
      ))}
    </section>

    <!-- Skills Section -->
    <section id="skills" class="section">
      <h2>{l.skills}</h2>
      <div class="skills-grid">
        {skills.categories.flatMap((category: any) =>
          category.skills.map((skill: any) => (
            <SkillTag skillName={skill.name} showStars={true} />
          ))
        )}
      </div>
    </section>

    <!-- Awards & Recognition Section -->
    {misc.awards && misc.awards.length > 0 && (
      <section id={`awards-${lang}`} class="section" data-section="awards">
        <h2>{l.awards}</h2>
        {misc.awards.map((award: any) => (
          <div class="award-item">
            <div class="award-header">
              <h3>{award.title}</h3>
              <p class="text-muted award-year">{award.year}</p>
            </div>
            <p class="text-muted">{award.organization}</p>
            {award.description && <p>{award.description}</p>}
          </div>
        ))}
      </section>
    )}

    <!-- Contact Section -->
    <section id={`contact-${lang}`} class="section contact-section" data-section="contact">
      <h2>{l.contact}</h2>
      <p>{l.contactText}</p>
      <div class="contact-links">
        <a href={`mailto:${intro.email}`} class="button">{l.sendEmail}</a>
      </div>
    </section>
  </main>
    );
  })}

  <Footer />
</BaseLayout>

<style>
  .hero {
    padding: var(--space-lg) 0;
  }

  .hero-content {
    display: flex;
    align-items: center;
    gap: var(--space-xl);
  }

  .profile-image-wrapper {
    flex-shrink: 0;
  }

  .profile-image {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--color-border);
    transition: border-color var(--transition-normal), transform var(--transition-normal);
  }

  .profile-image:hover {
    border-color: var(--color-accent);
    transform: scale(1.05);
  }

  .hero-text {
    flex: 1;
  }

  .hero h1 {
    font-size: 3rem;
    margin-bottom: var(--space-sm);
  }

  .hero h1 .degree {
    font-weight: 400;
    opacity: 0.8;
  }

  .tagline {
    font-size: 1.5rem;
    margin-bottom: var(--space-sm);
    color: var(--color-muted);
  }

  .hero-tagline {
    font-size: 1rem;
    line-height: 1.5;
  }

  .contact-links {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-lg);
    flex-wrap: wrap;
  }

  .contact-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    transition: all var(--transition-fast);
    font-size: 0.9rem;
  }

  .contact-link:hover {
    background-color: var(--color-bg-secondary);
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  .contact-link .icon {
    width: 18px;
    height: 18px;
  }

  /* Bio expandable section */
  .bio-expandable {
    position: relative;
  }

  .bio-preview {
    margin-bottom: var(--space-md);
  }

  .bio-full {
    animation: slideDown 0.3s ease-out;
  }

  .bio-toggle {
    background: transparent;
    border: none;
    color: var(--color-accent);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
    font-weight: 500;
    font-size: 0.95rem;
    transition: color var(--transition-fast);
    margin-top: var(--space-sm);
    font-family: inherit;
  }

  .bio-toggle:hover {
    color: var(--color-accent-hover);
  }

  .bio-toggle .chevron {
    transition: transform var(--transition-normal);
    flex-shrink: 0;
  }

  /* Timeline items (for experience & education) */
  .timeline-item {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .timeline-item:last-child {
    border-bottom: none;
  }

  .timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-md);
    gap: var(--space-lg);
  }

  .timeline-header h3 {
    margin-bottom: var(--space-xs);
  }

  .date {
    white-space: nowrap;
    font-size: 0.9rem;
  }

  /* Project cards */
  .project-card {
    margin-bottom: var(--space-xl);
    padding: var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    transition: border-color var(--transition-normal);
  }

  .project-card:hover {
    border-color: var(--color-accent);
  }

  .project-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-lg);
    margin-bottom: var(--space-md);
  }

  .project-title-area {
    flex: 1;
  }

  .project-card h3 {
    margin-bottom: var(--space-xs);
  }

  .video-thumbnail {
    width: 120px;
    height: 68px;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
  }

  .video-thumbnail::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .video-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
  }

  .video-thumbnail:hover::before {
    opacity: 1;
  }

  .play-icon {
    color: white;
    font-size: 2rem;
    position: relative;
    z-index: 1;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .video-container {
    margin-bottom: var(--space-lg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .video-container iframe {
    display: block;
    width: 100%;
  }

  .project-links {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-md);
  }

  /* Publication items */
  .publication-item {
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--color-border);
  }

  .publication-item:last-child {
    border-bottom: none;
  }

  .publication-item h3 {
    margin-bottom: var(--space-xs);
  }

  .publication-links {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-md);
  }

  /* Collapsible abstract */
  .abstract-toggle {
    margin: var(--space-md) 0;
  }

  .abstract-toggle summary {
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
    color: var(--color-accent);
    font-weight: 500;
    font-size: 0.9rem;
    transition: color var(--transition-fast);
    user-select: none;
  }

  .abstract-toggle summary::-webkit-details-marker {
    display: none;
  }

  .abstract-toggle summary:hover {
    color: var(--color-accent-hover);
  }

  .abstract-toggle summary .chevron {
    transition: transform var(--transition-normal);
    flex-shrink: 0;
  }

  .abstract-toggle[open] summary .chevron {
    transform: rotate(180deg);
  }

  .abstract-content {
    margin-top: var(--space-sm);
    padding: var(--space-md);
    background-color: var(--color-bg-secondary);
    border-left: 3px solid var(--color-accent);
    border-radius: 4px;
    line-height: 1.7;
    color: var(--color-text-secondary);
  }

  /* Skills */
  .skills-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
  }

  /* Awards */
  .award-item {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .award-item:last-child {
    border-bottom: none;
  }

  .award-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-lg);
    margin-bottom: var(--space-xs);
  }

  .award-header h3 {
    margin-bottom: 0;
  }

  .award-year {
    white-space: nowrap;
    font-size: 0.9rem;
  }

  /* Tags */
  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-md);
  }

  .tag {
    display: inline-block;
    padding: var(--space-xs) var(--space-md);
    background-color: var(--color-bg-secondary);
    border-radius: 4px;
    font-size: 0.85rem;
    color: var(--color-foreground);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
    cursor: help;
  }

  .tag:hover {
    background-color: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  /* Contact Section */
  .contact-section {
    text-align: center;
  }

  .contact-section .contact-links {
    justify-content: center;
  }

  /* Button */
  .button {
    display: inline-block;
    padding: var(--space-md) var(--space-lg);
    background-color: var(--color-accent);
    color: white;
    border-radius: 6px;
    font-weight: 500;
    transition: background-color var(--transition-fast);
  }

  .button:hover {
    background-color: var(--color-accent-hover);
    color: white;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .hero-content {
      flex-direction: column;
      text-align: center;
      gap: var(--space-lg);
    }

    .profile-image {
      width: 150px;
      height: 150px;
    }

    .contact-links {
      justify-content: center;
    }

    .hero h1 {
      font-size: 2rem;
    }

    .tagline {
      font-size: 1.25rem;
    }

    .timeline-header {
      flex-direction: column;
      gap: var(--space-sm);
    }

    .date {
      white-space: normal;
    }

    .award-header {
      flex-direction: column;
      gap: var(--space-xs);
    }

    .award-year {
      white-space: normal;
    }

    .project-header {
      flex-direction: column;
      gap: var(--space-md);
    }

    .video-thumbnail {
      width: 100%;
      height: 180px;
    }

    .video-container iframe {
      height: 250px;
    }
  }
</style>

<script>
  // Initialize Lucide icons
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }

  // Handle video thumbnail clicks
  document.addEventListener('DOMContentLoaded', () => {
    const thumbnails = document.querySelectorAll('.video-thumbnail');

    thumbnails.forEach(thumbnail => {
      thumbnail.addEventListener('click', () => {
        const projectIndex = thumbnail.getAttribute('data-project-index');
        const videoContainer = document.querySelector(`.video-container[data-project-index="${projectIndex}"]`);

        if (videoContainer) {
          if (videoContainer.style.display === 'none') {
            // Show video
            videoContainer.style.display = 'block';
            thumbnail.style.opacity = '0.5';
          } else {
            // Hide video
            videoContainer.style.display = 'none';
            thumbnail.style.opacity = '1';
          }
        }
      });
    });

    // Handle bio expand/collapse
    const bioToggles = document.querySelectorAll('.bio-toggle');

    bioToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const expandable = button.closest('.bio-expandable');
        if (!expandable) return;

        const bioFull = expandable.querySelector('.bio-full') as HTMLElement;
        const toggleText = button.querySelector('.toggle-text');
        const chevron = button.querySelector('.chevron') as HTMLElement;
        const lang = button.getAttribute('data-lang-scope');

        if (bioFull.style.display === 'none') {
          // Expand
          bioFull.style.display = 'block';
          if (toggleText) toggleText.textContent = lang === 'en' ? 'Read less' : 'Weniger lesen';
          if (chevron) chevron.style.transform = 'rotate(180deg)';
        } else {
          // Collapse
          bioFull.style.display = 'none';
          if (toggleText) toggleText.textContent = lang === 'en' ? 'Read more' : 'Mehr lesen';
          if (chevron) chevron.style.transform = 'rotate(0deg)';
        }
      });
    });
  });
</script>
