---
/**
 * SkillsChart.astro - A component to visualize the distribution of skills
 */
import skillsDatabase from '../content/skillsDatabase.json';

interface Props {
  title: string;
  yAxisTitle: string;
  xAxisTitle: string;
}

const { title, yAxisTitle, xAxisTitle } = Astro.props;

// 1. Process the skills data to get star distribution
const levelToStars: Record<string, number> = {
  'beginner': 1,
  'competent': 2,
  'proficient': 3,
  'expert': 4,
  'wizard': 5
};

const starCounts = [0, 0, 0, 0, 0]; // Index 0 for 1 star, etc.
for (const key in skillsDatabase.skills) {
  const skill = skillsDatabase.skills[key];
  const starLevel = levelToStars[skill.level];
  if (starLevel >= 1 && starLevel <= 5) {
    starCounts[starLevel - 1]++;
  }
}

// 2. SVG parameters for the histogram
const svgWidth = 200;
const svgHeight = 50;
const chartPadding = { top: 0, right: 0, bottom: 0, left: 0 };
const chartWidth = svgWidth - chartPadding.left - chartPadding.right;
const chartHeight = svgHeight - chartPadding.top - chartPadding.bottom;

const maxCount = Math.max(...starCounts);
const barWidth = chartWidth / starCounts.length - 30; // 10px gap

const bars = starCounts.map((count, i) => {
  const barHeight = maxCount > 0 ? (count / maxCount) * chartHeight : 0;
  const x = chartPadding.left + i * (barWidth + 2) + 2;
  const y = chartPadding.top + chartHeight - barHeight;
  return { x, y, width: barWidth, height: barHeight, count };
});

const yAxisLabels = [0, Math.round(maxCount / 2), maxCount];
---

<div class="chart-container">
  <h3>{title}</h3>
  <svg viewBox={`0 0 ${svgWidth} ${svgHeight}`} role="img" aria-labelledby="chart-title">
    <title id="chart-title">Histogram of skill proficiency levels based on star ratings.</title>
    
    {/* Y-axis with labels */}
    <g class="axis y-axis">
      <line x1={chartPadding.left} y1={chartPadding.top} x2={chartPadding.left} y2={chartPadding.top + chartHeight} />
      {yAxisLabels.map(label => {
        const y = chartPadding.top + chartHeight - (maxCount > 0 ? (label / maxCount) * chartHeight : 0);
        return (
          <text x={chartPadding.left - 8} y={y} dy="0.3em" text-anchor="end">{label}</text>
        )
      })}
       <text
        class="axis-title"
        transform={`rotate(-90)`}
        y={chartPadding.left-30}
        x={-(chartHeight / 2) - chartPadding.top}
        text-anchor="middle"
      >
        {yAxisTitle}
      </text>
    </g>

    {/* X-axis with labels */}
    <g class="axis x-axis">
      <line x1={chartPadding.left} y1={chartPadding.top + chartHeight} x2={svgWidth - chartPadding.right} y2={chartPadding.top + chartHeight} />
      {bars.map((bar, i) => (
        <text x={bar.x + bar.width / 2} y={chartPadding.top + chartHeight + 20} text-anchor="middle">
          {i + 1} â˜…
        </text>
      ))}
       <text
        class="axis-title"
        x={chartPadding.left + chartWidth / 2}
        y={svgHeight - 5}
        text-anchor="middle"
      >
        {xAxisTitle}
      </text>
    </g>

    {/* Bars */}
    <g class="bars">
      {bars.map(bar => (
        <g>
          <rect x={bar.x} y={bar.y} width={bar.width} height={bar.height} class="bar"></rect>
          <text x={bar.x + bar.width / 2} y={bar.y - 8} text-anchor="middle" class="bar-label">{bar.count}</text>
        </g>
      ))}
    </g>
  </svg>
</div>

<style>
  .chart-container {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: var(--space-lg);
    margin-top: var(--space-2xl);
    text-align: center;
  }
  .chart-container h3 {
    margin-bottom: var(--space-lg);
    color: var(--color-foreground);
  }
  svg {
    width: 100%;
    max-width: 500px;
    height: auto;
    font-family: var(--font-sans);
  }
  .axis line, .axis path {
    stroke: var(--color-border);
    stroke-width: 1;
  }
  .axis text {
    fill: var(--color-muted);
    font-size: 12px;
  }
  .axis .axis-title {
      font-size: 14px;
      fill: var(--color-text-secondary);
  }
  .bar {
    fill: var(--color-accent);
    transition: fill var(--transition-fast);
  }
  .bar:hover {
    fill: var(--color-accent-hover);
  }
  .bar-label {
    font-size: 14px;
    font-weight: 500;
    fill: var(--color-accent);
  }
</style>
